<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>예약 화면</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="../css/room.css">
    <style>

        img. {
            margin-left: 5px;
            vertical-align: middle;
            cursor: pointer;
        }
    </style>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" type="text/css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous"></script>
<!--    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"-->
<!--            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"-->
<!--            crossorigin="anonymous"></script>-->
    <link rel="stylesheet" type="text/css" href="../css/_layout.css">
</head>

<body>
<div style="background-image:url(../img/community.jpg);
        width: auto; height: 630px;" >
    <header th:include="header::header"></header>
    <div class="community_title fadeIn">객 실 예 약</div>
    <div style="display: none" class="session_id" th:text="${session.userID}">세션 아이디</div>
</div>

<div class="room_reserve"> 예약 하기 </div>
<!--------------예약 박스------------------>
<div class="book_box" >
    <table style="border-spacing: 3px" class="book_box_style">
        <tr >
            <td class="book_box_style">
                <p>체크인</p>
                <input type="text" name="from" id="from" placeholder="Check In">
            </td>
            <td class="book_box_style"> <p>체크아웃</p>
                <input type="text" name="to" id="to"><br>
            </td>
            <td class="book_box_style"><p>객실선택</p>
                    <label>
                        <select class="room_select">
                            <option value="Standard">Standard</option>
                            <option value="Superior">Superior</option>
                            <option value="Deluxe">Deluxe</option>
                        </select>
                    </label>
            </td>
            <td class="book_box_style"><p>인원선택</p>
                <label>
                    <select class="person_select">
                        <option value="2">2인</option>
                        <option value="4">3~4인</option>
                        <option value="6">5~6인</option>

                    </select>
                </label>
            </td>
            <td class="book_box_style"><button class="cheking_room">확인</button></td>
        </tr>


    </table>
    <button class="getRoom">예약 가능 객실</button>
    <div>원하시는 객실 타입을 선택 후 클릭해주세요.</div>
    <!--<div th:text="${rooms}"></div>-->
    <div class="getRoom_modal" >
        <table style="text-align: center;">
            <thead>
            <th class="t-head">객실 타입</th>
            <th class="t-head"> 날짜 </th>
            <th class="t-head">남은 객실</th>
            </thead>
            <tbody class="room_list">


            </tbody>
        </table>
    <div style="color: #ff007a">오후 12시에 스케줄러 실행.
        <button class="getRoomClose" style="margin: 10px; left: 40px" > 닫기.</button>
    </div>
    </div>

<!--    <h4>객실 예약</h4>-->

<!--    <p>체크인</p>-->
<!--    <input type="text" name="from" id="from" placeholder="Check In">-->
<!--    <p>체크아웃</p>-->
<!--    <input type="text" name="to" id="to"><br><br>-->

<!--    <div>객실선택 :-->
<!--        <label>-->
<!--            <select class="room_select">-->
<!--                <option value="">객실선택</option>-->
<!--                <option value="Standard">Standard</option>-->
<!--                <option value="Superial">Superial</option>-->
<!--                <option value="Delux">Delux</option>-->
<!--            </select>-->
<!--        </label>-->
<!--    </div>-->

<!--    <div>인원선택 :-->
<!--        <label>-->
<!--            <select class="person_select">-->
<!--                <option value=""></option>-->
<!--                <option value="2">2인</option>-->
<!--                <option value="4">3~4인</option>-->
<!--                <option value="6">5~6인</option>-->

<!--            </select>-->
<!--        </label>-->
<!--    </div>-->
<!--    <button class="cheking_room">확인</button>-->
</div>

<!--슬라이드 박스-->
<div class="slide_container" >
    <div style="color: #ff007a"> *입실은 15시부터 가능합니다.</div>
    <table>
    <tr class="imgSelectBox" >
        <td style="border: 1px solid;padding: 20px"class="imgSelectBox_standard">스탼다드</td>
        <td style="border: 1px solid;padding: 20px"class="imgSelectBox_superial">슈페리얼</td>
        <td style="border: 1px solid;padding: 20px"class="imgSelectBox_delux">디럭스</td>
    </tr>
    </table>
    <div class="slide_fade">
        <div class="number_next"> 1/3</div>
        <img class="imgselect1" src="../img/room/standard1.jpg" style="width: 100%">
        <div class="slide_text"> 첫 번 째 사진</div>
    </div>
    <div class="slide_fade">
        <div class="number_next"> 2/3</div>
        <img class="imgselect2" src="../img/room/standard2.jpg" style="width: 100%; ">
        <div class="slide_text"> 2번 째 사진</div>
    </div>
    <div class="slide_fade">
        <div class="number_next"> 3/3</div>
        <img class="imgselect3" src="../img/room/standard3.jpg" style="width: 100%">
        <div class="slide_text"> 3 번 째 사진</div>
    </div>

    <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
    <a class="next" onclick="plusSlides(1)">&#10095;</a>

</div>
<script>
        $('.imgSelectBox_standard').click(function () {
            $('.imgselect1').attr('src','/img/room/standard1.jpg');
            for (var i=1; i<4; i++){
                $('.imgselect'+i).attr('src','/img/room/standard'+i+'.jpg');
            }
        });
        $('.imgSelectBox_superial').click(function () {
            $('.imgselect1').attr('src','/img/room/superior1.jpeg');
            for (var i=1; i<4; i++){
                $('.imgselect'+i).attr('src','/img/room/superior'+i+'.jpg');
            }
        });
        $('.imgSelectBox_delux').click(function () {
            $('.imgselect').attr('src','/img/room/delux1.jpeg');
            for (var i=1; i<4; i++){
                $('.imgselect'+i).attr('src','/img/room/delux'+i+'.jpg');
            }
        });

    var slideIndex = 1;
    showSlides(slideIndex);

    // Next/previous controls
    function plusSlides(n) {
        showSlides(slideIndex += n);
    }

    // Thumbnail image controls
    function currentSlide(n) {
        showSlides(slideIndex = n);
    }

    function showSlides(n) {
        var i;
        var slides = document.getElementsByClassName("slide_fade");
        var dots = document.getElementsByClassName("dot");
        if (n > slides.length) {slideIndex = 1}
        if (n < 1) {slideIndex = slides.length}
        for (i = 0; i < slides.length; i++) {
            slides[i].style.display = "none";
        }
        for (i = 0; i < dots.length; i++) {
            dots[i].className = dots[i].className.replace(" active", "");
        }
        slides[slideIndex-1].style.display = "block";
        dots[slideIndex-1].className += "active";
    }
</script>

<!--------------팝업 위젯 지불 계산 기능------------------>
<div class="popup_widget">
    <div class="widget_carculator">
        <h4 style="padding-bottom: 10px;" >Receipt</h4>
        <table>
            <tr class="row1">
                <th style="padding-right: 30">Room Type</th>
                <th style="padding-right: 30">Rate Days</th>
                <th style="padding-right: 30">Check In Date</th>
                <th style="padding-right: 30">Total</th>
            </tr>
            <tr>
                <td style="padding-right: 30" class="number_of_persons">standard</td>
                <td style="padding-right: 30" class="stay_days">3일 숙박</td>
                <td style="padding-right: 30" class="book_date">2019-02-91</td>
                <td class="total_pay" style="font-weight: bold; color: #ff007a;">10만원</td>
            </tr>
        </table>
        <div>입금 계좌 국민은행:123-123-11111**</div>
        <p style="padding-top: 10px;" align="center">입금 처리 완료 됩니다.</p>
        <button class="ok">결제 완료</button>
        <button class="cancel">결제 취소</button>
    </div>
</div>

<script>


    //--------------데이트피커-------------

    $("#from").datepicker({
        dateFormat: "yy-mm-dd",
        minDate: 1,
        onSelect: function () {
            var minDate = $(this).datepicker('getDate');
            var date2 = $('#from').datepicker('getDate');
            date2.setMonth(date2.getMonth() + 1);
            $('#to').datepicker('option', 'minDate', minDate);
            $('#to').datepicker('option', 'maxDate', date2);


        }

    });
    $('#to').datepicker({
        showOn: "both",
        dateFormat: "yy-mm-dd",
        minDate: 2,

        onClose: function () {
            var from = $('#from').datepicker('getDate');
            console.log(from);
            var to = $('#to').datepicker('getDate');
            if (to <= from) {
                alert("같은 날에 체크아웃 할 수 없습니다.");
                location.reload();
            }
        }
    });

    //데이트 피커 숙박일 수 계산 함수.
    function stayDate() {
        var toDate = $('#to').datepicker('getDate').getTime();
        var fromDate = $('#from').datepicker('getDate').getTime();
        if (toDate===fromDate){
            alert("날짜가같음");
            location.reload();
        }
        var timeDiff = Math.abs(fromDate - toDate);
        return Math.ceil(timeDiff / (1000 * 3600 * 24));
    }


    function alert_call(result, text) {
        $('.alert').fadeIn('slow');
        if (result) {
            $('.alert_success').text(text);
            $('.alert_success').fadeIn('slow');
        } else {
            $('.alert_fail').text(text);
            $('.alert_fail').fadeIn('slow');
        }
        setTimeout(function () {
            alert_close();
        }, 1500);
    }

    $(document).on('click', '.cheking_room', function () {

        var session_id = $('.session_id').text();
        if (!session_id) {
            alert("로그인 후 이용하세요.^~^");
            return false;
        }


        var required_room;
        var room = $('.room_select').val();
        var person = $('.person_select').val();
        var checkinDate = $('#from').val();
        var checkOutDate = $('#to').val();
        if (room == false || person == false || checkinDate == false || checkOutDate == false) {
            alert("빈 칸이 있습니다.");
            return false
        }
        var days = stayDate();
        var payMoney = pay();


        function pay() {
            if (room === 'Standard') {
                return Math.ceil(person / 2) * 10 * days;
            } else if (room === 'Superior') {
                return Math.ceil(person / 2) * 20 * days;
            } else {
                return Math.ceil(person / 2) * 30 * days;
            }
        }

        //정보 선택 후 뜨는 팝업창 호출.
        $('.popup_widget').fadeIn('fast').css({
            'margin-top': function () { //vertical centering
                return -($(this).height() /0.3);
            }});
        carculator();

        $('.cancel').click(function () {
            $('.popup_widget').fadeOut('fast')
        });
        //결제 완료 클릭시 함수호출.
        $('.ok').click(function () {
            roomSubmit();
        });


        function carculator() {

            if (room === 'Standard') {
                $('.number_of_persons').text(person + "명 이용");
                $('.room_number').append("<h3>객실</h3>").text(room);
                $('.stay_days').text(days + "일 숙박");
                $('.book_date').text("예약일: " + checkinDate);
                $('.total_pay').text("금액:" + payMoney+"만원");
            } else if (room === 'Superior') {
                $('.number_of_persons').text(person + "명 이용");
                $('.room_number').text(room + "객실");
                $('.stay_days').text(days + "일 숙박");
                $('.book_date').text("예약일: " + checkinDate);
                $('.total_pay').text("금액:" + payMoney+"만원");
            } else {
                if (room === 'Deluxe')
                    $('.number_of_persons').text(person + "명 이용");
                $('.room_number').text(room + "객실");
                $('.stay_days').text(days + "일 숙박");
                $('.book_date').text("예약일: " + checkinDate);
                $('.total_pay').text("금액:" + payMoney+"만원");
            }


        }

        function roomSubmit() {
            if (room === 'Standard') {
                required_room = Math.ceil(person / 2);
            } else if (room === 'Superior') {
                required_room = Math.ceil(person / 4);
            } else {
                required_room = Math.ceil(person / 6);
            }

            try {
                $.ajax({
                    url: '/roomcheck',
                    type: 'get',
                    async:false,
                    data: {'room_type': room, 'stay': days, 'required_room': required_room, 'room_date': checkinDate},
                    success: function (data) {
                        if (data === "AllSerene") {
                            alert("성공");
                            book_insert();
                        } else {
                            alert("fail");
                            //alert_message(false,data+"일의 남은 방이 없습니다.날짜를 조정해 주세요.")
                        }
                    }
                })
            } catch (e) {
                alert(e.message)
            } finally {
                window.location.reload();
            }
        }
        function book_insert() {

            $.ajax({
                url:'/book',
                type:'post',
                data:{'book_id':session_id
                    ,'room_type':room
                    ,'stay':days
                    ,'required_room':required_room
                    ,'checkin_date':checkinDate
                    ,'checkout_date':checkOutDate
                    ,'total_pay':payMoney
                }
                ,success:function(){
                    alert("book insert 성공")
                }
            })
        }




    });






</script>




<script th:inline="javascript">

    $('.getRoom').click(function () {
        $('.getRoom_modal').fadeIn('slow');

        var room = $('.room_select').val();
        var required_room = "1";
        $.ajax({
            url:'getRoomList',
            type:'get',
            data:{
                'room_type':room
                ,'required_room':required_room

            }
            ,success:function(data){

                // alert(Object.keys(data).length);
                var length = Object.keys(data).length;
                for (var i=0; i<length; i++) {
                    $('.room_list').append(
                        "<tr class='ajaxList'>"+
                            "<td class='append_style'>" + data[i].room_type + "</td>"+
                            "<td class='append_style'>" + data[i].room_date + "</td>"+
                            "<td class='append_style'>" + data[i].room_remain + "</td>"+
                        "</tr>"
                    )
                }
            }
        })

    })

    $('.getRoomClose').click(function () {
        $('.getRoom_modal').fadeOut('fast');
        $('.ajaxList').remove();

    });

</script>
<footer th:include="footer::footer"></footer>
</body>
</html>
